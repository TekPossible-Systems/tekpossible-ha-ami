---

- name: Assorted pre deployment configurations
  hosts: 'all'
  connection: local
  become: True
  tasks:

    - name: Install GPG Key AWS - Step 1
      copy:
        src: amazon-gpg-key
        dest: /etc/pki/rpm-gpg/amazon-gpg-key

    - name: Install EPEL Repo
      dnf: 
        name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
        disable_gpg_check: true
        state: installed
        
    - name: Install AWS SSM Agent
      dnf: 
        name: 'https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm'
        state: installed
    
    - name: Instal AWS EFS Utils
      dnf: 
        name: "https://cdn.amazonlinux.com/al2023/core/guids/9cf1057036ef7d615de550a658447fad88617805da0cfc9b854ba0fb8a668466/x86_64/../../../../blobstore/9866146da4d009f3e37eb83b7dd6361da7b87078e9b8be60a6e9fc9695d10533/amazon-efs-utils-1.35.0-1.amzn2023.noarch.rpm"
        state: installed
        disable_gpg_check: true

    - name: Enable AWS SSM Service
      ansible.builtin.systemd:
        name: amazon-ssm-agent
        state: started
        enabled: true

    - name: Ensure Codedeploy Agent dependency is installed
      dnf: 
        name: 'ruby'
        state: installed
        
    - name: Hostname Software dependencies
      dnf: 
        name: uuid
        state: installed

    - name: Update the system
      dnf: 
       name: '*'
       state: latest